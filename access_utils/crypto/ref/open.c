#include <string.h>
#include "crypto_hash_sha512.h"
#include "crypto_verify_32.h"
#include "ge25519.h"
#include "crypto_logger.h"

/* Packed coordinates of the base point */
const ge25519 ge25519_base = {
    {{0x1A, 0xD5, 0x25, 0x8F, 0x60, 0x2D, 0x56, 0xC9, 0xB2, 0xA7, 0x25, 0x95, 0x60, 0xC7, 0x2C, 0x69,
      0x5C, 0xDC, 0xD6, 0xFD, 0x31, 0xE2, 0xA4, 0xC0, 0xFE, 0x53, 0x6E, 0xCD, 0xD3, 0x36, 0x69, 0x21}},
    {{0x58, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
      0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66}},
    {{0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},
    {{0xA3, 0xDD, 0xB7, 0xA5, 0xB3, 0x8A, 0xDE, 0x6D, 0xF5, 0x52, 0x51, 0x77, 0x80, 0x9F, 0xF0, 0x20,
      0x7D, 0xE3, 0xAB, 0x64, 0x8E, 0x4E, 0xEA, 0x66, 0x65, 0x76, 0x8B, 0xD7, 0x0F, 0x5F, 0x87, 0x67}}};

int crypto_sign_open(unsigned char *m, unsigned long long *mlen, const unsigned char *sm, unsigned long long smlen,
                     const unsigned char *pk) {
  unsigned char pkcopy[32];
  unsigned char rcopy[32];
  unsigned char mcopy[smlen];
  unsigned char hram[64];
  unsigned char rcheck[32];
  ge25519 get1, get2;
  sc25519 schram, scs;

  if (smlen < 64) {
    log_error(crypto_logger_id, "[%s:%d] Error 1.\n", __func__, __LINE__);
  } else if (sm[63] & 224) {
    log_error(crypto_logger_id, "[%s:%d] Error 2.\n", __func__, __LINE__);
  } else if (ge25519_unpackneg_vartime(&get1, pk)) {
    log_error(crypto_logger_id, "[%s:%d] Error 3.\n", __func__, __LINE__);
  } else {
    log_info(crypto_logger_id, "[%s:%d] No error.\n", __func__, __LINE__);
  }

  if (smlen < 64) goto badsig;
  if (sm[63] & 224) goto badsig;
  if (ge25519_unpackneg_vartime(&get1, pk)) goto badsig;

  memmove(pkcopy, pk, 32);
  memmove(rcopy, sm, 32);

  sc25519_from32bytes(&scs, sm + 32);

  memmove(mcopy, sm, smlen);
  memmove(mcopy + 32, pkcopy, 32);
  crypto_hash_sha512(hram, mcopy, smlen);

  sc25519_from64bytes(&schram, hram);

  ge25519_double_scalarmult_vartime(&get2, &get1, &schram, &ge25519_base, &scs);
  ge25519_pack(rcheck, &get2);

  if (crypto_verify_32(rcopy, rcheck) == 0) {
    memmove(m, mcopy + 64, smlen - 64);
    memset(mcopy + smlen - 64, 0, 64);
    *mlen = smlen - 64;
    return 0;
  }

badsig:
  *mlen = (unsigned long long)-1;
  memset(m, 0, smlen);
  return -1;
}
